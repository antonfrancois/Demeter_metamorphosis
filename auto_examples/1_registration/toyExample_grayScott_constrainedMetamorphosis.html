

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title># #%% &mdash; Demeter_metamorphosis 0.2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=938c9ccc"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Kernel examples" href="../2_kernels/index.html" />
    <link rel="prev" title="MetaMorphosis behaviour with different values of rho" href="plot_simpleToyExample_metamorphosis.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Demeter_metamorphosis
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Gallery of examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#registration-examples">Registration examples</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html#kernel-examples">Kernel examples</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Registration examples</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="data_cost_mutualInformation.html">Data cost variation example:: Mutual Information</a></li>
<li class="toctree-l3"><a class="reference internal" href="metamorphosis_3D.html">Metamorphosis on 3D images</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_simpleToyExample_metamorphosis.html">MetaMorphosis behaviour with different values of rho</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#"># #%%</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">#%%</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../2_kernels/index.html">Kernel examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Demeter documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced_users.html">For advanced users</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Demeter_metamorphosis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Gallery of examples</a></li>
          <li class="breadcrumb-item"><a href="index.html">Registration examples</a></li>
      <li class="breadcrumb-item active"># #%%</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/auto_examples/1_registration/toyExample_grayScott_constrainedMetamorphosis.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-auto-examples-1-registration-toyexample-grayscott-constrainedmetamorphosis-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<p class="sphx-glr-example-title" id="toyexample-grayscott-joinedmetamorphosis"><span id="sphx-glr-auto-examples-1-registration-toyexample-grayscott-constrainedmetamorphosis-py"></span>This toy example was build to simulate a cancer growth in a brain.
The gray scott texture as been used to add intricate patterns to the
brain background.</p>
<p>import matplotlib.pyplot as plt</p>
<dl class="simple">
<dt>try:</dt><dd><p>import sys, os
# add the parent directory to the path
base_path  = os.path.join(os.path.dirname(os.path.abspath(__file__)),’..’)
sys.path.insert(0,base_path)
import __init__</p>
</dd>
<dt>except NameError:</dt><dd><p>pass</p>
</dd>
</dl>
<p>from demeter.constants import *
import torch
import kornia.filters as flt
# %reload_ext autoreload
# %autoreload 2
import demeter.utils.reproducing_kernels as rk
import demeter.metamorphosis as mt
import demeter.utils.torchbox as tb</p>
<p>device = ‘cpu’
if torch.cuda.is_available():</p>
<blockquote>
<div><p>device = ‘cuda:0’</p>
</div></blockquote>
<p>print(f”Used device: {device}”)
size = (300,300)</p>
<p>source_name,target_name = ‘teGS_mbs_S’,’teGS_mbs_T’</p>
<p>S = tb.reg_open(source_name,size = size).to(device)
T = tb.reg_open(target_name,size = size).to(device)
forDice_source = tb.reg_open(‘te_s_v_seg’,size=size)
forDice_target = tb.reg_open(‘teGS_mbs_segTdice’,size=size)
seg_necrosis = tb.reg_open(‘teGS_mbs_segNec’,size=size).to(device)
seg_oedeme = tb.reg_open(‘te_o_seg’,size=size)</p>
<p># S = torch.zeros_like(S)
# T = torch.zeros_like(T)</p>
<p># fig,ax = plt.subplots(2,2,figsize=(10,10))
# ax[0,0].imshow(S[0,0].cpu(),**DLT_KW_IMAGE)
# ax[0,0].set_title(‘source’)
# ax[0,1].imshow(T[0,0].cpu(),**DLT_KW_IMAGE)
# ax[0,1].set_title(‘target’)
# ax[1,0].imshow(tb.imCmp(S,T,’seg’),origin=’lower’)
# ax[1,0].set_title(‘superposition of S and T’)
# ax[1,1].imshow(tb.imCmp(forDice_source,seg_oedeme,’seg’),origin=’lower’)
# ax[1,1].set_title(‘segmentations’)
# # ax[2,0].imshow(tb.imCmp(seg_oedeme,forDice_target))
# # ax[2,1].imshow(tb.imCmp(ini_ball,seg_necrosis))
# plt.show()</p>
<dl class="simple">
<dt>source_landmarks = torch.Tensor([</dt><dd><p>[int(187),int(145)],
[int(160),int(65)],
[int(140),int(84)],
[int(145),int(210)],
[int(170),int(180)],
[int(125),int(105)],
[int(117),int(175)]</p>
</dd>
</dl>
<p>])
target_landmarks = torch.Tensor([</p>
<blockquote>
<div><p>[int(212),int(144)], # ok
[int(167),int(65)],
[int(131),int(80)], # ok
[int(135),int(222)], # ok
[int(197),int(202)], # ok
[int(110),int(100)], # ok
[int(101),int(189)] # ok</p>
</div></blockquote>
<p>])</p>
<p>id_grid = tb.make_regular_grid(size)</p>
<p>col1 = ‘C1’
col2 = ‘C9’
fig,ax = plt.subplots(1,3,figsize=(15,5))
ax[0].imshow(S[0,0].cpu(),**DLT_KW_IMAGE)
ax[0].plot(source_landmarks[:,0],source_landmarks[:,1],’x’,markersize=10,c=col2)
ax[1].imshow(T[0,0].cpu(),**DLT_KW_IMAGE)
ax[1].plot(source_landmarks[:,0],source_landmarks[:,1],’x’,markersize=10,c=col2)
ax[1].plot(target_landmarks[:,0],target_landmarks[:,1],’x’,markersize=10,c=col1)</p>
<dl class="simple">
<dt>ax[1].quiver(source_landmarks[:,0],source_landmarks[:,1],</dt><dd><p>target_landmarks[:,0]-source_landmarks[:,0],
target_landmarks[:,1]-source_landmarks[:,1],
color= GRIDDEF_YELLOW)</p>
</dd>
</dl>
<p>ax[2].imshow(tb.imCmp(T,S,’seg’),origin=’lower’)
ax[2].plot(source_landmarks[:,0],source_landmarks[:,1],’x’,markersize=10,c=col2)
ax[2].plot(target_landmarks[:,0],target_landmarks[:,1],’x’,markersize=10,c=col1)
for i in range(source_landmarks.shape[0]):</p>
<blockquote>
<div><dl class="simple">
<dt>ax[2].plot([source_landmarks[i,0],target_landmarks[i,0]],</dt><dd><p>[source_landmarks[i,1],target_landmarks[i,1]],’–‘,c=col1)</p>
</dd>
</dl>
</div></blockquote>
<p># - Residual_mask : a temporal mask with at each pixel a value between 0 and 1
#                  controlling the amount of deformation vs photometric changes.
# - orienting_field :a prior precomputed vector field that our deformation
#                          will try to match.
# - orienting_mask : a mask that will be used to weight the orienting field.
#                   for example, if we want to deform only a part, the rest
#                   we can indicate it with this mask.
#
# First we need to set source and target masks.</p>
<p>print(“`
==== Building temporal masks ====”)
val_o,val_n = .5,1
segs = torch.zeros(seg_necrosis.shape)
segs[seg_oedeme &gt; 0] = val_o
segs[seg_necrosis &gt; 0] = val_n
# plt.imshow(segs[0,0],vmin=0,vmax=1,cmap=’gray’)</p>
<p># make source image
center = (160,155)
ini_ball_n,_ = tb.make_ball_at_shape_center(</p>
<blockquote>
<div><p>seg_necrosis,verbose=True,force_r=8,force_center=center</p>
</div></blockquote>
<p>)
ini_ball_o,_ = tb.make_ball_at_shape_center(</p>
<blockquote>
<div><p>seg_necrosis,verbose=True,force_r=20,force_center=center</p>
</div></blockquote>
<p>)
ini_ball_on = torch.zeros(ini_ball_o.shape)
ini_ball_on[ini_ball_o &gt; 0] = val_o
ini_ball_on[ini_ball_n &gt; 0] = val_n</p>
<p># segs = torch.ones_like(segs) * .5
# ini_ball_on = torch.ones_like(ini_ball_on) * .5</p>
<p>fig, ax = plt.subplots(1,4,figsize=(15,5))
ax[0].imshow(segs[0,0],vmin=0,vmax=1,cmap=’gray’,origin=’lower’)
ax[0].set_title(‘segs’)
ax[1].imshow(ini_ball_on[0,0],vmin=0,vmax=1,cmap=’gray’,origin=’lower’)
ax[1].set_title(‘ini_ball_on’)
ax[2].imshow(tb.imCmp(ini_ball_on,segs,’seg’),origin=’lower’)
ax[2].set_title(‘superposition’)
ax[3].imshow(tb.imCmp(ini_ball_on,S,’seg’),origin=’lower’)
plt.show()
# # %%
#####################################################################
# Register the prior masks to the source and target images using LDDMM:
# First we build the kernel operator that will be used for the registration and
# fix other constants</p>
<p>## Build temporal masks</p>
<p>sigma = [(2,2),(5,5),(20,20)]
# sigma = [(10,10)]
kernelOp = rk.Multi_scale_GaussianRKHS(sigma,normalized=True)
rk.plot_kernel_on_image(kernelOp,subdiv=10,image=T.cpu())
plt.show()
print(kernelOp)
dx_convention = ‘square’
n_steps= 20</p>
<p>recompute = False
if recompute:</p>
<blockquote>
<div><p>momentum_ini = 0
mr_mask_orienting = mt.lddmm(ini_ball_n.to(device),seg_necrosis,momentum_ini,</p>
<blockquote>
<div><p>kernelOperator=kernelOp,cost_cst=1e-5,integration_steps=n_steps,
n_iter=10,grad_coef=1,
optimizer_method=’LBFGS_torch’,
dx_convention=dx_convention,)</p>
</div></blockquote>
<p>mr_mask_orienting.save(f”mask_tE_gs_CM_{dx_convention}_n_step{n_steps}_orienting”)</p>
</div></blockquote>
<dl>
<dt>else:</dt><dd><p>file = “2D_23_01_2025_mask_tE_gs_CM_square_n_step20_orienting_000.pk1”</p>
<p>mr_mask_orienting = mt.load_optimize_geodesicShooting(file)</p>
</dd>
</dl>
<p>mr_mask_orienting.compute_landmark_dist(source_landmarks,target_landmarks)
mr_mask_orienting.plot_imgCmp()
plt.show()
# #%%
# mr_mask_orienting.plot_deform()
mr_mask_orienting.mp.plot()
plt.show()
#%%
#####################################################################
# Register the residual mask to the source and target images using LDDMM:
print(“&gt;&gt;&gt;&gt; Mask for residuals field &lt;&lt;&lt;&lt;”)</p>
<dl>
<dt>if recompute:</dt><dd><p>momentum_ini = 0
mr_mask_residuals = mt.lddmm(ini_ball_on.to(device),segs,momentum_ini,</p>
<blockquote>
<div><p>kernelOperator=kernelOp,cost_cst=1e-5,integration_steps=n_steps,
n_iter=10,grad_coef=1,
optimizer_method=’LBFGS_torch’,
dx_convention=dx_convention,)</p>
</div></blockquote>
<p>mr_mask_residuals.save(f”mask_tE_gs_CM_{dx_convention}_n_step{n_steps}_residuals”)</p>
</dd>
<dt>else:</dt><dd><p># file = “2D_23_01_2025_mask_tE_gs_CM_square_necrosisOnly_000.pk1”
file =”2D_23_01_2025_mask_tE_gs_CM_square_n_step20_necrosisOnly_000.pk1”
# 2D_23_01_2025_mask_tE_gs_CM_square_n_step20_necrosisOnly_001.pk1</p>
<p>mr_mask_residuals = mt.load_optimize_geodesicShooting(file)</p>
</dd>
</dl>
<p>mr_mask_residuals.plot_imgCmp()
plt.show()
# #%%
# # file  =”2D_23_01_2025_mask_tE_gs_CM_square_000.pk1”
# # file = “2D_23_01_2025_mask_tE_gs_CM_square_all_000.pk1”
# file = “2D_23_01_2025_mask_tE_gs_CM_square_n_step20_necrosisOnly_000.pk1”
# mr_mask_oedeme = mt.load_optimize_geodesicShooting(file)
# mr_mask_oedeme.plot_imgCmp()
# plt.show()
# #%%
# # file  =”2D_23_01_2025_mask_tE_gs_CM_square_necrosisOnly_000.pk1”
# file = “2D_23_01_2025_mask_tE_gs_CM_square_n_step20all_000.pk1”
# mr_mask_necrosis = mt.load_optimize_geodesicShooting(file)
# mr_mask_necrosis.compute_landmark_dist(source_landmarks,target_landmarks)
# mr_mask_necrosis.plot_imgCmp()
# plt.show()</p>
<section id="id1">
<h1># #%%<a class="headerlink" href="#id1" title="Link to this heading"></a></h1>
<p># Finally, we extract the masks and the fields from the LDDMM object
# and tweak them to our linking.</p>
<p>residuals_mask = mr_mask_residuals.mp.image_stock.clone() #* .5
residuals_mask = 1 - residuals_mask</p>
<p>orienting_field = mr_mask_orienting.mp.field_stock.clone()
# In this case we though best to set the orienting mask as
# at constant value
# orienting_mask = torch.ones(residuals_mask.shape)
# orienting_mask <a href="#id2"><span class="problematic" id="id3">*</span></a>= 1
# # but you can try with different types of masks, like the one below
orienting_mask = mr_mask_residuals.mp.image_stock.clone()
orienting_mask[orienting_mask&gt;.5] =.7</p>
<p>sig = 2 # blur the mask to avoid sharp transitions
residuals_mask = flt.gaussian_blur2d(residuals_mask,(int(6*sig)+1,int(6*sig)+1),(sig,sig))
sig = 5
orienting_mask = flt.gaussian_blur2d(orienting_mask,(int(6*sig)+1,int(6*sig)+1),(sig,sig))</p>
<p>L = [0,2,8,-1]
fig,ax = plt.subplots(2,len(L),figsize=(len(L)*5,10))
for i,ll in enumerate(L):</p>
<blockquote>
<div><p>ax[0,i].imshow(orienting_mask[ll,0].cpu(),cmap=’gray’,vmin=0, vmax = 1,origin = “lower”)
tb.quiver_plot(orienting_mask[ll,0][…,None].cpu() * orienting_field[ll][None].cpu(),</p>
<blockquote>
<div><p>ax[0,i],
step = 10,color=’C3’,dx_convention=dx_convention)</p>
</div></blockquote>
<p>ax[1,i].imshow(residuals_mask[ll,0].cpu(),cmap=’gray’,vmin=0, vmax = 1,origin = “lower”)</p>
</div></blockquote>
<p>plt.show()</p>
<p># #%%
fig1,ax1 = plt.subplots(1,1)
ax1.plot(orienting_mask[-1,0,:,150].cpu(),label=”orienting_mask”)
ax1.plot(residuals_mask[-1,0,:,150].cpu(),label=”residuals_mask”)
ax1.set_ylim(0,1)
ax1.legend()
plt.title(‘orienting and residuals masks profiles cut at x=150’)
# l = orienting_mask.shape[0]
# L = range(l)
# fig,ax = plt.subplots(l,1,figsize=(10,l*10))
plt.show()</p>
<p>sigma = [(5,5),(20,20),(30,30)]
kernelOp = rk.Multi_scale_GaussianRKHS(sigma,normalized=True)</p>
<p>print(kernelOp)</p>
</section>
<section id="id4">
<h1>#%%<a class="headerlink" href="#id4" title="Link to this heading"></a></h1>
<p># We are now ready to perform the registration with the constrained metamorphosis
# orienting_field =None
# orienting_mask = None
# you can also load the optimisation object from a file
# file = “2D_25_01_2025_TEST_toyExample_grayScott_CM_square_n_step20_000.pk1”
# mr = mt.load_optimize_geodesicShooting(file)</p>
<p>print(”
==== Constrained Metamorphosis ====”)
momentum_ini = 0
# momentum_ini = mr_cm.to_analyse[0]
ic.disable()
mr_cm = mt.constrained_metamorphosis(S,T,momentum_ini,</p>
<blockquote>
<div><blockquote>
<div><p>orienting_mask,
orienting_field,
residuals_mask,
kernelOperator=kernelOp,
cost_cst=.00001,
grad_coef=.1,</p>
</div></blockquote>
<dl>
<dt>n_iter=10,</dt><dd><dl class="simple">
<dt>dx_convention=dx_convention,</dt><dd><p># optimizer_method=’adadelta’,</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
</div></blockquote>
<p>mr_cm.compute_landmark_dist(source_landmarks,target_landmarks)
mr_cm.plot_cost()
plt.show()</p>
<p>#%%
mr_cm.plot_imgCmp()
plt.show()</p>
<p>#%%</p>
<p>mr_cm.plot_deform()
plt.show()</p>
<p>#%%
mr_cm.mp.plot()</p>
<p>#%%
mr_cm.save(f”TEST_toyExample_grayScott_CM_{dx_convention}_n_step{n_steps}”)</p>
<p>#%%
plt.show()</p>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 0.000 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-1-registration-toyexample-grayscott-constrainedmetamorphosis-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/c44a3968c0bda4f75a82c930e384eab9/toyExample_grayScott_constrainedMetamorphosis.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">toyExample_grayScott_constrainedMetamorphosis.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/4b0423c2e873af104d18843e1889171a/toyExample_grayScott_constrainedMetamorphosis.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">toyExample_grayScott_constrainedMetamorphosis.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/c3c3f9b11f520e609795e13754ff573c/toyExample_grayScott_constrainedMetamorphosis.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">zipped:</span> <span class="pre">toyExample_grayScott_constrainedMetamorphosis.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="plot_simpleToyExample_metamorphosis.html" class="btn btn-neutral float-left" title="MetaMorphosis behaviour with different values of rho" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../2_kernels/index.html" class="btn btn-neutral float-right" title="Kernel examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Anton François.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>